<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive lab experiments by Alessandro Trysh.">
    <title>Lab - Experiments</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
    <script data-goatcounter="https://alexdevflow.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <style>
        :root {
            --primary-bg: rgb(239, 224, 197);
            --secondary-bg: rgb(241, 236, 226);
            --button-bg: #3498db;
            --primary-color: #333333;
            --accent-color: #09a7e0;
            --text-color: #555555;
            --heading-font: "Montserrat", sans-serif;
            --body-font: "Roboto", sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            display: block;
            min-height: 100vh;
            background-color: var(--primary-bg);
            overflow: hidden;
            font-family: var(--body-font);
        }

        main {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3rem;
            min-height: 100vh;
            width: 100%;
            padding: 2.5rem 1.5rem 3rem;
            box-sizing: border-box;
            text-align: center;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            z-index: -1;
        }

        .back-button {
            display: inline-block;
            margin-top: 2.5rem;
            padding: 12px 25px;
            background-color: var(--button-bg);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            z-index: 1;
            position: relative;
        }

        @media (max-width: 768px) {
            .back-button {
                margin-top: 150px;
                font-size: 1rem;
                padding: 10px 20px;
            }
        }

        .back-button:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
        }

        .language-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 20;
        }

        .language-switch button {
            background: linear-gradient(135deg, var(--button-bg), var(--accent-color));
            color: white;
            border: none;
            border-radius: 999px;
            padding: 10px 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .language-switch button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.2);
        }

        .language-switch button:active {
            transform: translateY(0);
            opacity: 0.9;
        }

        .skip-link {
            position: absolute;
            left: -999px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        .skip-link:focus {
            position: fixed;
            left: 20px;
            top: 20px;
            width: auto;
            height: auto;
            clip: auto;
            padding: 10px 16px;
            background: var(--button-bg);
            color: #fff;
            border-radius: 6px;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }
    </style>
</head>
<body>
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="language-switch">
        <button id="labLangToggle" type="button" aria-label="Toggle language" aria-pressed="false">IT</button>
    </div>
    <main id="main-content">
        <canvas id="canvas"></canvas>
        <a href="../" class="back-button" data-i18n="lab.back">Go Back Home</a>
    </main>
    
    <script>
    const translations = {
        en: {
            greetings: ["Welcome to the Lab!", "Experiments are brewing..."],
            "lab.back": "Go Back Home"
        },
        it: {
            greetings: ["Benvenuto nel Lab!", "Gli esperimenti stanno prendendo forma..."],
            "lab.back": "Torna alla Home"
        }
    };

    const storageKey = 'alexdevflow-lang';
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const backButton = document.querySelector('.back-button');
    const langToggle = document.getElementById('labLangToggle');
    
    // Simple mobile detection
    const isMobile = (window.innerWidth || 800) <= 768;
    
    // Adaptive settings
    const particleCount = isMobile ? 2000 : 6000;
    const maxDistance = isMobile ? 80 : 100;
    
    function resizeCanvas() {
        canvas.width = window.innerWidth || 800;
        canvas.height = window.innerHeight || 600;
    }
    
    resizeCanvas();
    
    let greetings = translations.en.greetings;
    let currentGreetingIndex = 0;
    
    // Responsive font size
    function getFontSize() {
        const width = window.innerWidth || 800;
        const baseSize = Math.min(width / 12, 80);
        return Math.max(baseSize, 24); // Minimum 24px
    }
    
    let fontSize = getFontSize();
    ctx.font = `bold ${fontSize}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    const particles = [];

    function Particle(x, y) {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.size = 2;
        this.baseX = x;
        this.baseY = y;
        this.density = (Math.random() * 30) + 1;
    }

    Particle.prototype.draw = function() {
        ctx.fillStyle = '#272727';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.closePath();
        ctx.fill();
    }

    Particle.prototype.update = function() {
        let dx = mouse.x - this.x;
        let dy = mouse.y - this.y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        let forceDirectionX = dx / distance;
        let forceDirectionY = dy / distance;
        let force = (maxDistance - distance) / maxDistance;
        let directionX = forceDirectionX * force * this.density;
        let directionY = forceDirectionY * force * this.density;

        if (distance < maxDistance && mouse.x !== null && mouse.y !== null) {
            this.x -= directionX;
            this.y -= directionY;
        } else {
            if (this.x !== this.baseX) {
                let dx = this.x - this.baseX;
                this.x -= dx / 10;
            }
            if (this.y !== this.baseY) {
                let dy = this.y - this.baseY;
                this.y -= dy / 10;
            }
        }
    }

    function getTextY() {
        return canvas.height * 0.4; // push greeting up to leave room for the button
    }

    function drawGreeting(text) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#d2b48c';
        ctx.fillText(text, canvas.width / 2, getTextY());
    }

    function init() {
        particles.length = 0;
        
        if (canvas.width === 0 || canvas.height === 0) {
            resizeCanvas();
        }
        
        fontSize = getFontSize();
        ctx.font = `bold ${fontSize}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        drawGreeting(greetings[currentGreetingIndex]);
        const textCoordinates = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < particleCount; i++) {
            let x, y;
            do {
                x = Math.floor(Math.random() * canvas.width);
                y = Math.floor(Math.random() * canvas.height);
            } while (textCoordinates.data[(y * 4 * textCoordinates.width) + (x * 4) + 3] <= 128);
            
            particles.push(new Particle(x, y));
        }
    }

    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < particles.length; i++) {
            particles[i].draw();
            particles[i].update();
        }
        requestAnimationFrame(animate);
    }

    const mouse = {
        x: null,
        y: null
    }

    // Touch handling variables
    let touchStartTime = null;
    let touchTimeout = null;
    const TAP_DURATION = 300; // Threshold for tap vs long press in ms
    const ANIMATION_DURATION = 300; // Duration for tap animation in ms

    // Mouse events
    window.addEventListener('mousemove', function(event) {
        if (!isMobile) {
            mouse.x = event.x;
            mouse.y = event.y;
        }
    });

    // Touch events for mobile
    window.addEventListener('touchstart', function(event) {
        event.preventDefault();
        if (event.touches.length > 0) {
            mouse.x = event.touches[0].clientX;
            mouse.y = event.touches[0].clientY;
            touchStartTime = Date.now();
            
            touchTimeout = setTimeout(() => {
                touchStartTime = null;
            }, TAP_DURATION);
        }
    });

    window.addEventListener('touchmove', function(event) {
        event.preventDefault();
        if (event.touches.length > 0) {
            mouse.x = event.touches[0].clientX;
            mouse.y = event.touches[0].clientY;
        }
    });

    window.addEventListener('touchend', function(event) {
        event.preventDefault();
        if (touchTimeout) {
            clearTimeout(touchTimeout);
            touchTimeout = null;
        }

        if (touchStartTime && (Date.now() - touchStartTime < TAP_DURATION)) {
            setTimeout(() => {
                mouse.x = null;
                mouse.y = null;
            }, ANIMATION_DURATION);
        } else {
            mouse.x = null;
            mouse.y = null;
        }
        touchStartTime = null;
    });

    function applyLanguage(lang) {
        if (!translations[lang]) return;
        document.documentElement.lang = lang;
        greetings = translations[lang].greetings;
        currentGreetingIndex = 0;
        backButton.textContent = translations[lang]['lab.back'];
        langToggle.textContent = lang === 'it' ? 'ðŸ‡®ðŸ‡¹ Italiano' : 'ðŸ‡¬ðŸ‡§ English';
        langToggle.setAttribute('aria-pressed', lang === 'it' ? 'true' : 'false');
        init();
    }

    function initLanguage() {
        const saved = localStorage.getItem(storageKey);
        const browserLang = (navigator.language || 'en').slice(0, 2);
        const startingLang = saved || (browserLang === 'it' ? 'it' : 'en');
        applyLanguage(startingLang);
    }

    initLanguage();
    animate();

    langToggle.addEventListener('click', () => {
        const current = document.documentElement.lang === 'it' ? 'it' : 'en';
        const next = current === 'en' ? 'it' : 'en';
        localStorage.setItem(storageKey, next);
        applyLanguage(next);
    });

    window.addEventListener('resize', function() {
        resizeCanvas();
        init();
    });

    setInterval(() => {
        currentGreetingIndex = (currentGreetingIndex + 1) % greetings.length;
        drawGreeting(greetings[currentGreetingIndex]);
        const textCoordinates = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < particles.length; i++) {
            let x, y;
            do {
                x = Math.floor(Math.random() * canvas.width);
                y = Math.floor(Math.random() * canvas.height);
            } while (textCoordinates.data[(y * 4 * textCoordinates.width) + (x * 4) + 3] <= 128);
            
            particles[i].baseX = x;
            particles[i].baseY = y;
        }
    }, 5000);
    </script>
</body>
</html>